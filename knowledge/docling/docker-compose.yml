# ============================================================
# Zoocari - Zoo Q&A Chatbot with Local Kokoro TTS
# ============================================================
#
# Quick Start:
#   docker compose up --build
#
# With Admin Portal:
#   docker compose --profile admin up --build
#
# Environment Variables (set in .env):
#   - OPENAI_API_KEY (required): OpenAI API key for chat & STT
#   - ADMIN_USERNAME/PASSWORD: Admin portal credentials
#
# ============================================================

services:
  # ============================================================
  # Ollama - Local LLM Inference
  # ============================================================
  ollama:
    image: ollama/ollama:latest
    container_name: zoocari-ollama
    ports:
      - "11434:11434"
    volumes:
      - zoocari-ollama-models:/root/.ollama
    environment:
      - OLLAMA_KEEP_ALIVE=24h
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - zoocari
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 4G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Kokoro TTS - FastAPI Sidecar Service
  # ============================================================
  kokoro-tts:
    image: ghcr.io/remsky/kokoro-fastapi-cpu:latest
    container_name: zoocari-kokoro-tts
    ports:
      - "8880:8880"
    environment:
      - TARGET_MIN_TOKENS=100
      - TARGET_MAX_TOKENS=200
      - DEFAULT_VOICE=af_heart
    volumes:
      - zoocari-kokoro-models:/app/models
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8880/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - zoocari
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Main API - FastAPI Backend
  # ============================================================
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    container_name: zoocari-api
    ports:
      - "8000:8000"
    volumes:
      # Persist data (LanceDB, sessions, config)
      - ./data:/app/data
      # Persist model cache (Kokoro, Whisper)
      - zoocari-hf-cache:/root/.cache/huggingface
      - zoocari-torch-cache:/root/.cache/torch
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:?OPENAI_API_KEY is required}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY:-}
      - TTS_PROVIDER=${TTS_PROVIDER:-kokoro}
      - TTS_VOICE=${TTS_VOICE:-af_heart}
      - STT_PROVIDER=${STT_PROVIDER:-faster-whisper}
      - KOKORO_TTS_URL=http://kokoro-tts:8880
      - OLLAMA_URL=http://ollama:11434
      - OLLAMA_MODEL=phi4
      - OLLAMA_GUARD_MODEL=llama-guard3:1b
      - LLM_PROVIDER=${LLM_PROVIDER:-ollama}
      - LANCEDB_PATH=/app/data/zoo_lancedb
      - SESSION_DB_PATH=/app/data/sessions.db
      - PYTHONUNBUFFERED=1
      - HF_HOME=/root/.cache/huggingface
      - TORCH_HOME=/root/.cache/torch
    env_file:
      - path: .env
        required: false
    depends_on:
      - ollama
      - kokoro-tts
    restart: unless-stopped
    networks:
      - zoocari
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Web Frontend - React/Vite
  # ============================================================
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    container_name: zoocari-web
    ports:
      - "3000:80"
    depends_on:
      - api
    restart: unless-stopped
    networks:
      - zoocari
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Cloudflare Tunnel (HTTPS for mobile voice support)
  # ============================================================
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: zoocari-tunnel
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN:-}
    volumes:
      - ./cloudflare:/etc/cloudflared:ro
    depends_on:
      - api
      - web
    networks:
      - zoocari
    profiles:
      - tunnel

  # ============================================================
  # Admin Portal - API Backend
  # ============================================================
  admin-api:
    build:
      context: ./apps/admin-api
      dockerfile: Dockerfile
    container_name: zoocari-admin-api
    ports:
      - "8001:8000"
    volumes:
      - ./data:/app/data
    environment:
      - PYTHONUNBUFFERED=1
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-zoocari-admin}
      - JWT_SECRET=${JWT_SECRET:-zoocari-jwt-secret-change-in-production}
      - SESSION_DB_PATH=/app/data/sessions.db
      - LANCEDB_PATH=/app/data/zoo_lancedb
      - CONFIG_PATH=/app/data/admin_config.json
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
    env_file:
      - path: .env
        required: false
    depends_on:
      - api
    restart: unless-stopped
    networks:
      - zoocari
    profiles:
      - admin
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Admin Portal - React Frontend
  # ============================================================
  admin-web:
    build:
      context: ./apps/admin
      dockerfile: Dockerfile
    container_name: zoocari-admin-web
    ports:
      - "3001:80"
    depends_on:
      - admin-api
    restart: unless-stopped
    networks:
      - zoocari
    profiles:
      - admin
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Shared network for all services
networks:
  zoocari:
    name: zoocari-network

# Named volumes for persistent model cache
volumes:
  zoocari-hf-cache:
    name: zoocari-hf-cache
  zoocari-torch-cache:
    name: zoocari-torch-cache
  zoocari-kokoro-models:
    name: zoocari-kokoro-models
  zoocari-ollama-models:
    name: zoocari-ollama-models
