# ============================================================
# Zoocari - Zoo Q&A Chatbot with Local Kokoro TTS
# ============================================================
#
# Quick Start:
#   docker compose up --build
#
# With Admin Portal:
#   docker compose --profile admin up --build
#
# Environment Variables (set in .env):
#   - OPENAI_API_KEY (required): OpenAI API key for chat & STT
#   - ADMIN_USERNAME/PASSWORD: Admin portal credentials
#
# ============================================================

services:
  # ============================================================
  # Main API - FastAPI Backend
  # ============================================================
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    container_name: zoocari-api
    ports:
      - "8000:8000"
    volumes:
      # Persist data (LanceDB, sessions, config)
      - ./data:/app/data
      # Persist model cache (Kokoro, Whisper)
      - zoocari-hf-cache:/root/.cache/huggingface
      - zoocari-torch-cache:/root/.cache/torch
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:?OPENAI_API_KEY is required}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY:-}
      - TTS_PROVIDER=${TTS_PROVIDER:-kokoro}
      - TTS_VOICE=${TTS_VOICE:-af_heart}
      - STT_PROVIDER=${STT_PROVIDER:-faster-whisper}
      - LANCEDB_PATH=/app/data/zoo_lancedb
      - SESSION_DB_PATH=/app/data/sessions.db
      - PYTHONUNBUFFERED=1
      - HF_HOME=/root/.cache/huggingface
      - TORCH_HOME=/root/.cache/torch
    env_file:
      - path: .env
        required: false
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Web Frontend - React/Vite
  # ============================================================
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    container_name: zoocari-web
    ports:
      - "3000:80"
    depends_on:
      - api
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Cloudflare Tunnel (HTTPS for mobile voice support)
  # ============================================================
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: zoocari-tunnel
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN:-}
    volumes:
      - ./cloudflare:/etc/cloudflared:ro
    depends_on:
      - api
    profiles:
      - tunnel

  # ============================================================
  # Admin Portal - API Backend
  # ============================================================
  admin-api:
    build:
      context: ./apps/admin-api
      dockerfile: Dockerfile
    container_name: zoocari-admin-api
    ports:
      - "8001:8000"
    volumes:
      - ./data:/app/data
    environment:
      - PYTHONUNBUFFERED=1
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-zoocari-admin}
      - JWT_SECRET=${JWT_SECRET:-zoocari-jwt-secret-change-in-production}
      - SESSION_DB_PATH=/app/data/sessions.db
      - LANCEDB_PATH=/app/data/zoo_lancedb
      - CONFIG_PATH=/app/data/admin_config.json
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
    env_file:
      - path: .env
        required: false
    depends_on:
      - api
    restart: unless-stopped
    profiles:
      - admin
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Admin Portal - React Frontend
  # ============================================================
  admin-web:
    build:
      context: ./apps/admin
      dockerfile: Dockerfile
    container_name: zoocari-admin-web
    ports:
      - "3001:80"
    depends_on:
      - admin-api
    restart: unless-stopped
    profiles:
      - admin
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Named volumes for persistent model cache
volumes:
  zoocari-hf-cache:
    name: zoocari-hf-cache
  zoocari-torch-cache:
    name: zoocari-torch-cache
