# Production Dockerfile for Zoocari API
# Multi-stage build with frontend build, ML model pre-download, and static serving

# ============================================================================
# Stage 1: Frontend build stage
# ============================================================================
FROM node:20-slim AS frontend-builder

WORKDIR /app

# Copy package files and install dependencies
COPY apps/web/package*.json ./
RUN npm ci

# Copy source and build
COPY apps/web/ ./
RUN npm run build

# ============================================================================
# Stage 2: ML models pre-download stage
# ============================================================================
FROM python:3.12-slim AS builder

# Install system dependencies for model downloads
RUN apt-get update && apt-get install -y \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /models

# Install Python dependencies needed for model downloads
RUN pip install --no-cache-dir \
    faster-whisper>=1.0.0 \
    kokoro>=0.9.4 \
    huggingface-hub

# Pre-download Faster-Whisper base model for STT
# This prevents cold start delays in production
RUN python -c "from faster_whisper import WhisperModel; WhisperModel('base', device='cpu', compute_type='int8')"

# Pre-download Kokoro TTS model (if available via HuggingFace)
# Kokoro models are cached in ~/.cache/kokoro or similar
RUN python -c "import kokoro; kokoro.generate('test', voice='af_heart')" || true

# ============================================================================
# Stage 3: Production runtime
# ============================================================================
FROM python:3.12-slim

# Install system dependencies for runtime
# espeak-ng: Required for Kokoro TTS phonemization
# libsndfile1: Required for audio file I/O (soundfile)
# curl: Health check support
RUN apt-get update && apt-get install -y \
    espeak-ng \
    libsndfile1 \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user for security
RUN useradd -m -u 1000 zoocari && \
    mkdir -p /app /app/data && \
    chown -R zoocari:zoocari /app

WORKDIR /app

# Copy requirements and install Python dependencies
COPY apps/api/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy pre-downloaded models from builder stage to zoocari user's home
# Models must be accessible by the non-root user
COPY --from=builder /root/.cache /home/zoocari/.cache
RUN chown -R zoocari:zoocari /home/zoocari/.cache

# Copy application code
COPY apps/api/app ./app
COPY apps/api/.env.example .env.example

# Copy knowledge base builder scripts (for conditional initialization)
COPY zoo_build_knowledge.py .
COPY zoo_sources.py .
COPY utils ./utils

# Install additional dependencies for knowledge base building
RUN pip install --no-cache-dir docling docling-core

# Copy built frontend static files from frontend-builder stage
# These will be served by FastAPI using StaticFiles middleware
COPY --from=frontend-builder /app/dist ./static

# Copy entrypoint script
COPY docker/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Create data directory for LanceDB and SQLite
RUN mkdir -p /app/data && chown -R zoocari:zoocari /app/data

# Switch to non-root user
USER zoocari
ENV HOME=/home/zoocari

# Expose API port
EXPOSE 8000

# Health check (with longer start period for knowledge base build)
HEALTHCHECK --interval=30s --timeout=10s --start-period=600s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# Use entrypoint for conditional knowledge base initialization
ENTRYPOINT ["/entrypoint.sh"]
